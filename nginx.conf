# --- GLOBAL SETTINGS ---
events {
    worker_connections 1024;      # Maximum number of simultaneous connections per worker process
}

http {
    # --- LOGGING FORMAT ---
    # Defines a custom log format named 'json_combined' in JSON format for easier parsing by Loki/Promtail
    log_format json_combined escape=json '{'
        '"time_local":"$time_local",'     # Local time of the request
        '"remote_addr":"$remote_addr",'   # IP address of the client
        '"status": "$status",'            # HTTP response status code (e.g., 200, 404, 500)
        '"request":"$request"'            # The full request line (e.g., "GET /index.html HTTP/1.1")
    '}';

    # Path where access logs are stored, using the JSON format defined above
    access_log /var/log/nginx/web_access.log json_combined;

    # --- HTTP TO HTTPS REDIRECT ---
    server {
        listen 80;                        # Listens on port 80 (Standard HTTP)
        server_name local.host;           # Responds to requests for 'local.host'
        # Permanently redirects (301) all HTTP traffic to the HTTPS version of the site
        return 301 https://local.host$request_uri;
    }

    # --- MAIN HTTPS SERVER ---
    server {
        listen 443 ssl;                   # Listens on port 443 with SSL/TLS encryption enabled
        server_name local.host;           # Responds to requests for 'local.host'

        # SSL Certificate paths (must match the volume mounts in your docker-compose)
        ssl_certificate /etc/nginx/certs/nginx.crt;
        ssl_certificate_key /etc/nginx/certs/nginx.key;

        # Standard Proxy Headers: Ensures the backend apps know the real client's info
        proxy_set_header Host $http_host;                       # Passes the original Host header
        proxy_set_header X-Real-IP $remote_addr;                # Passes the real client IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Tracks the chain of proxies
        proxy_set_header X-Forwarded-Proto $scheme;             # Tells backend if request was http or https
        proxy_set_header X-Forwarded-Host $http_host;           # Passes the original host name

        # 1. Authelia Portal
        location /authelia {
            # Routes traffic starting with /authelia to the Authelia container on port 9091
            proxy_pass http://authelia:9091/authelia;
        }

        # 2. Protected Webapp (Root)
        location / {
            # Sends a background request to the internal verify endpoint to check if user is logged in
            auth_request /authelia/api/verify;
            
            # Saves the current URL to redirect back here after a successful login
            auth_request_set $target_url $scheme://$http_host$request_uri;
            
            # If Authelia returns 401 (Unauthorized), redirect the browser to the Authelia login page
            error_page 401 =302 https://local.host/authelia/#/?rd=$target_url;

            # If authorized, forward the request to the 'webapp' container
            proxy_pass http://webapp:80; 
        }

        # 3. Grafana (Accessible without Authelia protection)
        location /grafana/ {
            # Routes traffic to the Grafana container on port 3000
            proxy_pass http://grafana:3000/;
            # Note: Authelia is bypassed here to allow using Grafana's built-in login
        }

        # 4. Internal Verification Endpoint
        # This is a special location used only by Nginx to talk to Authelia; it's hidden from the public
        location = /authelia/api/verify {
            internal;                                           # Prevents external access to this path
            proxy_pass http://authelia:9091/authelia/api/verify; # Points to Authelia's API
            
            # Passes authentication headers and original request info to Authelia for validation
            proxy_set_header Proxy-Authorization $http_authorization;
            proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
            proxy_set_header Host authelia;
            
            # Optimization: Authelia only needs the headers, so we don't send the request body
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
        }
    }
}
